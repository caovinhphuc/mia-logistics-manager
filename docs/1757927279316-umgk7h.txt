# HÆ°á»›ng dáº«n cÃ¡c biáº¿n trong dá»± Ã¡n TransportRequests

## ğŸ“‹ Tá»•ng quan

File nÃ y mÃ´ táº£ cÃ¡c biáº¿n quan trá»ng trong `/src/features/shipments/components/TransportRequests.tsx` Ä‘á»ƒ trÃ¡nh nháº§m láº«n khi phÃ¡t triá»ƒn.

## ğŸ”§ CÃ¡c biáº¿n chÃ­nh

### 1. **State Variables (useState)**

#### Form Data

```typescript
const [newTransportForm, setNewTransportForm] = useState({
  // ThÃ´ng tin cÆ¡ báº£n
  pickupLocation: '', // ID cá»§a Ä‘iá»ƒm nguá»“n
  selectedTransfers: new Set<string>(), // Set cÃ¡c ID phiáº¿u Ä‘Ã£ chá»n
  status: '', // Tráº¡ng thÃ¡i yÃªu cáº§u
  note: '', // Ghi chÃº

  // ThÃ´ng tin váº­n chuyá»ƒn
  carrierName: '', // TÃªn nhÃ  váº­n chuyá»ƒn
  carrierId: '', // ID nhÃ  váº­n chuyá»ƒn
  pricingMethod: '', // PhÆ°Æ¡ng thá»©c tÃ­nh tiá»n (perKm, perM3, perTrip)
  vehicleType: '', // Loáº¡i xe

  // ThÃ´ng tin tÃ i xáº¿
  driverId: '', // MÃ£ tÃ i xáº¿
  driverName: '', // TÃªn tÃ i xáº¿
  driverPhone: '', // Sá»‘ Ä‘iá»‡n thoáº¡i tÃ i xáº¿
  driverLicense: '', // Sá»‘ báº±ng lÃ¡i

  // HÃ¬nh áº£nh vÃ  phÃ²ng ban
  loadingImages: '', // HÃ¬nh áº£nh lÃªn hÃ ng
  department: '', // PhÃ²ng ban sá»­ dá»¥ng

  // Äá»‹nh giÃ¡ vÃ  phÃ­ phá»¥
  serviceArea: '', // Khu vá»±c phá»¥c vá»¥
  pricePerKm: 0, // GiÃ¡/km (VNÄ)
  pricePerM3: 0, // GiÃ¡/khá»‘i (VNÄ/mÂ³)
  pricePerTrip: 0, // GiÃ¡/chuyáº¿n (VNÄ)
  stopFee: 0, // Chi phÃ­ Ä‘iá»ƒm dá»«ng (VNÄ/Ä‘iá»ƒm)
  fuelSurcharge: 0, // PhÃ­ phá»¥ xÄƒng (VNÄ)
  tollFee: 0, // PhÃ­ cáº§u Ä‘Æ°á»ng (VNÄ)
  insuranceFee: 0, // PhÃ­ báº£o hiá»ƒm (VNÄ)
  baseRate: 0, // Base rate (VNÄ)
});
```

#### UI State

```typescript
const [currentRequestId, setCurrentRequestId] = useState<string | null>(null);
const [currentRowIndex, setCurrentRowIndex] = useState<number | null>(null);
const [editing, setEditing] = useState(false);
const [open, setOpen] = useState(false);
const [closingDialog, setClosingDialog] = useState(false);
const [activeTab, setActiveTab] = useState(0);
const [generatingId, setGeneratingId] = useState(false);
const [submittingRequest, setSubmittingRequest] = useState(false);
```

#### Selection State

```typescript
const [selectedStopPoints, setSelectedStopPoints] = useState<Set<string>>(
  new Set()
);
const [selectedTransferInStop, setSelectedTransferInStop] = useState<
  string | null
>(null);
const [selectedItems, setSelectedItems] = useState<Set<string>>(new Set());
```

#### Distance Calculation State

```typescript
const [calculatedDistance, setCalculatedDistance] = useState<number | null>(
  null
); // âš ï¸ BIáº¾N CÅ¨ - KHÃ”NG DÃ™NG
const [isCalculatingDistance, setIsCalculatingDistance] = useState(false); // âš ï¸ BIáº¾N CÅ¨ - KHÃ”NG DÃ™NG
```

### 2. **Hook Variables**

#### Distance Calculation Hook

```typescript
const {
  distances: stopPointDistances, // âœ… BIáº¾N Má»šI - DÃ™NG CHO KHOáº¢NG CÃCH
  isCalculating,
  error,
  calculateStopDistances,
  getDistancePayload,
} = useDistanceCalculation();
```

#### Cost Calculation Hook

```typescript
const { calculateCost } = useTransportCostCalculation();
```

### 3. **Data Variables**

#### API Data

```typescript
const [transportRequests, setTransportRequests] = useState<Transfer[]>([]);
const [locations, setLocations] = useState<Location[]>([]);
const [carriers, setCarriers] = useState<Carrier[]>([]);
```

#### Computed Data

```typescript
const groupedLocations = useMemo(() => {
  /* ... */
}, [locations]);
const groupedCarriers = useMemo(() => {
  /* ... */
}, [carriers]);
const filteredTransfers = useMemo(() => {
  /* ... */
}, [transportRequests, newTransportForm.pickupLocation]);
```

## ğŸš¨ CÃ¡c biáº¿n quan trá»ng cáº§n lÆ°u Ã½

### **Khoáº£ng cÃ¡ch (Distance)**

```typescript
// âŒ BIáº¾N CÅ¨ - KHÃ”NG DÃ™NG
calculatedDistance; // TÃ­nh tá»« function cÅ©, cÃ³ thá»ƒ = 0

// âœ… BIáº¾N Má»šI - DÃ™NG CHO TÃNH TOÃN
stopPointDistances; // TÃ­nh tá»« hook useDistanceCalculation
Object.values(stopPointDistances).reduce((sum, distance) => sum + distance, 0); // Tá»•ng khoáº£ng cÃ¡ch
```

### **PhÆ°Æ¡ng thá»©c tÃ­nh tiá»n (Pricing Method)**

```typescript
// Sheet format (tá»« Google Sheets)
'PER_KM'; // TÃ­nh theo km
'PER_M3'; // TÃ­nh theo khá»‘i
'PER_TRIP'; // TÃ­nh theo chuyáº¿n

// Form format (trong React component)
'perKm'; // TÃ­nh theo km
'perM3'; // TÃ­nh theo khá»‘i
'perTrip'; // TÃ­nh theo chuyáº¿n
```

### **Mapping giá»¯a 2 format**

```typescript
const pricingMethodMap: { [key: string]: 'perKm' | 'perTrip' | 'perM3' } = {
  PER_KM: 'perKm',
  PER_TRIP: 'perTrip',
  PER_M3: 'perM3',
};

const reverseMap: { [key: string]: string } = {
  perKm: 'PER_KM',
  perM3: 'PER_M3',
  perTrip: 'PER_TRIP',
};
```

## ğŸ”„ CÃ¡c function quan trá»ng

### **TÃ­nh toÃ¡n chi phÃ­**

```typescript
// Function cÅ© - sá»­ dá»¥ng cho "Chi phÃ­ váº­n chuyá»ƒn"
calculateEstimatedCost()  // Tráº£ vá» sá»‘ tiá»n (number)

// Component má»›i - sá»­ dá»¥ng cho "Chi tiáº¿t tÃ­nh toÃ¡n chi phÃ­"
<CostCalculationDetails formData={{...}} />  // Hiá»ƒn thá»‹ chi tiáº¿t
```

### **TÃ¬m thÃ´ng tin carrier**

```typescript
getSelectedCarrierInfo(); // Tráº£ vá» carrier object hoáº·c null
```

### **Validation**

```typescript
validateTransportSubmission(); // Tráº£ vá» { ok: boolean, messages: string[] }
```

## âš ï¸ LÆ°u Ã½ quan trá»ng

1. **KHÃ”NG dÃ¹ng `calculatedDistance`** - biáº¿n cÅ©, cÃ³ thá»ƒ = 0
2. **DÃ™NG `stopPointDistances`** - biáº¿n má»›i tá»« hook
3. **Mapping format** - luÃ´n chuyá»ƒn Ä‘á»•i giá»¯a sheet format vÃ  form format
4. **Validation** - kiá»ƒm tra `stopPointDistances` thay vÃ¬ `calculatedDistance`
5. **TÃ­nh toÃ¡n chi phÃ­** - 2 nÆ¡i khÃ¡c nhau, cáº§n Ä‘á»“ng bá»™

## ğŸ”§ CÃ¡ch sá»­ dá»¥ng Ä‘Ãºng

### **Láº¥y tá»•ng khoáº£ng cÃ¡ch**

```typescript
// âœ… ÄÃšNG
const totalDistance = Object.values(stopPointDistances).reduce(
  (sum, distance) => sum + distance,
  0
);

// âŒ SAI
const totalDistance = calculatedDistance || 0;
```

### **Validation khoáº£ng cÃ¡ch**

```typescript
// âœ… ÄÃšNG
const distanceOk =
  Object.values(stopPointDistances).reduce(
    (sum, distance) => sum + distance,
    0
  ) > 0;

// âŒ SAI
const distanceOk = !!calculatedDistance && calculatedDistance > 0;
```

### **Mapping pricing method**

```typescript
// âœ… ÄÃšNG
const sheetPricingMethod =
  pricingMethodMap[formPricingMethod] || formPricingMethod;
const formPricingMethod = reverseMap[sheetPricingMethod] || 'perKm';
```

## ğŸ“ Cáº­p nháº­t

- **NgÃ y táº¡o:** 26/08/2025
- **PhiÃªn báº£n:** 1.1
- **Cáº­p nháº­t cuá»‘i:** 26/08/2025 - Debug transfer_ids khÃ´ng ghi nháº­n vÃ o sheet

## ğŸ”§ Cáº£i tiáº¿n má»›i (v1.1)

### **ThÃ´ng bÃ¡o thÃ nh cÃ´ng cáº£i tiáº¿n**

- âœ… **Chi phÃ­ Æ°á»›c tÃ­nh Ä‘Ãºng**: TÃ­nh láº¡i `calculateEstimatedCost()` trÆ°á»›c khi hiá»ƒn thá»‹
- âœ… **ThÃ´ng tin Ä‘áº§y Ä‘á»§**: Hiá»ƒn thá»‹ táº¥t cáº£ thÃ´ng tin tá»« báº£ng tá»•ng há»£p
- âœ… **Chi tiáº¿t Ä‘iá»ƒm dá»«ng**: Liá»‡t kÃª tá»«ng Ä‘iá»ƒm dá»«ng vá»›i khoáº£ng cÃ¡ch, kiá»‡n, khá»‘i lÆ°á»£ng

### **Tá»‘i Æ°u tá»‘c Ä‘á»™**

- âœ… **Loading state**: Hiá»ƒn thá»‹ "Äang xá»­ lÃ½ yÃªu cáº§u váº­n chuyá»ƒn..."
- âœ… **TÃ­nh khoáº£ng cÃ¡ch thÃ´ng minh**: Chá»‰ tÃ­nh náº¿u chÆ°a cÃ³ dá»¯ liá»‡u
- âœ… **Non-blocking reload**: KhÃ´ng await `fetchTransfers()` Ä‘á»ƒ khÃ´ng block UI
- âœ… **Debug logs**: Chá»‰ hiá»ƒn thá»‹ trong development mode

### **Hiá»ƒn thá»‹ transfer_id (v1.1)**

- âœ… **ThÃªm transferId**: VÃ o interface TransportRequest
- âœ… **Transform dá»¯ liá»‡u**: Map tá»« `transfer.transfer_id`
- âœ… **Hiá»ƒn thá»‹ trong báº£ng**: DÆ°á»›i requestCode vá»›i format "ID: [transfer_id]"
- âœ… **Hiá»ƒn thá»‹ trong Tab 2**: DÆ°á»›i má»—i chip phiáº¿u vá»›i format "ID: [transfer_id]"
- âœ… **Danh sÃ¡ch Transfer IDs**: Trong pháº§n tá»•ng há»£p vá»›i táº¥t cáº£ transfer_id Ä‘Ã£ chá»n

### **Sheet TransportRequests - Transfer IDs (v1.1)**

- âœ… **10 cá»™t má»›i**: `stop1TransferIds` Ä‘áº¿n `stop10TransferIds`
- âœ… **Backend headers**: Cáº­p nháº­t `TRANSPORT_REQUESTS_REQUIRED` (102 cá»™t)
- âœ… **Frontend mapping**: Táº¡o danh sÃ¡ch transfer_ids cho tá»«ng Ä‘iá»ƒm dá»«ng
- âœ… **Format dá»¯ liá»‡u**: Transfer IDs Ä‘Æ°á»£c join báº±ng dáº¥u pháº©y (", ")
- âœ… **Script tá»± Ä‘á»™ng**: `add-transfer-ids-columns.cjs` Ä‘á»ƒ thÃªm cá»™t an toÃ n

### **Debug Transfer IDs (v1.1)**

- âœ… **Cá»™t Ä‘Ã£ tá»“n táº¡i**: 10 cá»™t transfer_ids Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o sheet (cá»™t 89-98)
- âœ… **Backend headers**: `TRANSPORT_REQUESTS_REQUIRED` Ä‘Ã£ cÃ³ Ä‘á»§ 98 cá»™t
- âœ… **Frontend mapping**: Logic táº¡o `stopTransferIds` Ä‘Ã£ Ä‘Æ°á»£c implement
- âœ… **Debug logs**: ThÃªm logs Ä‘á»ƒ kiá»ƒm tra dá»¯ liá»‡u frontend vÃ  backend
  - ğŸ” **Váº¥n Ä‘á»**: Transfer IDs khÃ´ng Ä‘Æ°á»£c ghi nháº­n vÃ o sheet khi táº¡o yÃªu cáº§u
  - ğŸ” **NguyÃªn nhÃ¢n cÃ³ thá»ƒ**: Logic mapping `selectedTransfersForStop` hoáº·c `transferId`
  - ğŸ”§ **Fix Ä‘Ã£ thá»±c hiá»‡n**:
    - Sá»­ dá»¥ng `t.transferId || t.id` trong `stopPoints.transfers`
    - Cáº­p nháº­t logic lá»c `selectedTransfersForStop` Ä‘á»ƒ so sÃ¡nh Ä‘Ãºng `transferId`

  - ğŸ” **Váº¥n Ä‘á»**: KhÃ´ng cÃ³ validation cho sá»‘ Ä‘iá»ƒm dá»«ng (cÃ³ thá»ƒ vÆ°á»£t quÃ¡ 10 Ä‘iá»ƒm)
  - ğŸ”§ **Fix Ä‘Ã£ thá»±c hiá»‡n**:
    - ThÃªm validation trong `handleTransferClick`: kiá»ƒm tra tá»‘i Ä‘a 10 Ä‘iá»ƒm dá»«ng
    - ThÃªm validation trong `handleSubmitNewRequest`: kiá»ƒm tra Ã­t nháº¥t 1 Ä‘iá»ƒm, tá»‘i Ä‘a 10 Ä‘iá»ƒm
    - ThÃªm cáº£nh bÃ¡o visual trong "ThÃ´ng tin tá»•ng há»£p": chip Ä‘á»•i mÃ u Ä‘á» khi > 10 Ä‘iá»ƒm
    - ThÃªm validation trong "Danh sÃ¡ch Ä‘iá»ƒm giao hÃ ng": disable chip khi Ä‘Ã£ Ä‘áº¡t 10 Ä‘iá»ƒm
    - Hiá»ƒn thá»‹ thÃ´ng bÃ¡o cáº£nh bÃ¡o khi vÆ°á»£t quÃ¡ giá»›i háº¡n

  - ğŸ” **Váº¥n Ä‘á»**: Thiáº¿u cá»™t "SL sáº£n pháº©m" trong báº£ng dá»¯ liá»‡u Ä‘á» nghá»‹ váº­n chuyá»ƒn
  - ğŸ”§ **Fix Ä‘Ã£ thá»±c hiá»‡n**:
    - ThÃªm cá»™t "SL sáº£n pháº©m" vÃ o TableHead
    - ThÃªm ná»™i dung hiá»ƒn thá»‹ `totalProducts` trong TableBody
    - Mapping dá»¯ liá»‡u tá»« `transfer.quantity` sang `totalProducts`
    - Hiá»ƒn thá»‹ "N/A" khi khÃ´ng cÃ³ dá»¯ liá»‡u

  - ğŸ” **Váº¥n Ä‘á»**: Thiáº¿u thÃ´ng tin "SL sáº£n pháº©m" trong Tab 2 "Äiá»ƒm giao hÃ ng"
  - ğŸ”§ **Fix Ä‘Ã£ thá»±c hiá»‡n**:
    - ThÃªm trÆ°á»ng `totalProducts` vÃ o interface `DeliveryPoint`
    - Cáº­p nháº­t logic tÃ­nh toÃ¡n trong `getDeliveryPoints()` Ä‘á»ƒ tÃ­nh tá»•ng sá»‘ sáº£n pháº©m
    - ThÃªm chip "SL sáº£n pháº©m" vÃ o hiá»ƒn thá»‹ má»—i Ä‘iá»ƒm giao hÃ ng (mÃ u xanh lÃ¡)
    - ThÃªm chip "SL sáº£n pháº©m" vÃ o pháº§n "Tá»•ng há»£p" (mÃ u xanh lÃ¡)
    - Logic tÆ°Æ¡ng tá»± nhÆ° sá»‘ kiá»‡n vÃ  sá»‘ khá»‘i Ä‘Ã£ cÃ³ tá»« trÆ°á»›c

  - ğŸ” **Váº¥n Ä‘á»**: CÃ¡c cá»™t `stop1Products` Ä‘áº¿n `stop10Products` vÃ  `totalProducts` chÆ°a Ä‘Æ°á»£c ghi nháº­n vÃ o sheet
  - ğŸ”§ **Fix Ä‘Ã£ thá»±c hiá»‡n**:
    - ThÃªm logic tÃ­nh toÃ¡n `stopProducts` cho tá»«ng Ä‘iá»ƒm dá»«ng trong `handleSubmitNewRequest`
    - ThÃªm logic tÃ­nh toÃ¡n `totalProducts` tá»•ng há»£p
    - ThÃªm `stopProducts` vÃ  `totalProducts` vÃ o payload gá»­i Ä‘áº¿n backend
    - ThÃªm debug logs Ä‘á»ƒ kiá»ƒm tra dá»¯ liá»‡u sáº£n pháº©m
    - Äáº£m báº£o dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u vÃ o cÃ¡c cá»™t tÆ°Æ¡ng á»©ng trong Google Sheets

  ### **Test Results (v1.2)**
  - âœ… **Script test táº¡o request**: Táº¡o thÃ nh cÃ´ng Ä‘á» nghá»‹ váº­n chuyá»ƒn vá»›i Ä‘áº§y Ä‘á»§ trÆ°á»ng sáº£n pháº©m
  - âœ… **Backend response**: Nháº­n vÃ  xá»­ lÃ½ Ä‘Ãºng cÃ¡c trÆ°á»ng `stop1Products`, `stop2Products`, `stop3Products`, `totalProducts`
  - âœ… **Google Sheets verification**: CÃ¡c trÆ°á»ng sáº£n pháº©m Ä‘Ã£ Ä‘Æ°á»£c lÆ°u Ä‘Ãºng vÃ o sheet
  - âœ… **Data validation**: Dá»¯ liá»‡u sáº£n pháº©m khá»›p giá»¯a frontend, backend vÃ  sheet
  - ThÃªm debug logs chi tiáº¿t Ä‘á»ƒ kiá»ƒm tra mapping

### **Test Results (v1.1)**

- âœ… **Script test**: Táº¡o thÃ nh cÃ´ng Ä‘á» nghá»‹ váº­n chuyá»ƒn vá»›i Ä‘áº§y Ä‘á»§ dá»¯ liá»‡u
- âœ… **Backend**: Nháº­n vÃ  xá»­ lÃ½ dá»¯ liá»‡u Ä‘Ãºng
- âŒ **Transfer IDs**: `stop1TransferIds` vÃ  `stop2TransferIds` váº«n rá»—ng
- âš ï¸ **Format**: Má»™t sá»‘ trÆ°á»ng cÃ³ giÃ¡ trá»‹ nhÆ°ng format khÃ´ng Ä‘Ãºng
- ğŸ” **NguyÃªn nhÃ¢n**: Logic mapping trong frontend váº«n cáº§n debug thÃªm
